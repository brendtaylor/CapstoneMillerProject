<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Project/api/src/controllers/file.controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Project/api/src/controllers/file.controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file file.controller.js
 * Controller for handling HTTP requests related to file uploads, retrieval, and deletion.
 * Delegates business logic to FileService.
 */

const { FileService } = require("../services/file.service");

class FileController {
    /**
     * Finds a file by its key and streams the raw binary data back to the client.
     * Sets the appropriate Content-Type header based on the file's MIME type.
     * 
     * @route GET /api/file/:key
     * 
     * @param {Object} req - Express request object.
     * @param {string} req.params.key - The unique key of the file.
     * @param {Object} res - Express response object.
     */
    static async getFileByKey(req, res){
        try{
            const key = req.params.key;
            const file = await FileService.findOneByKey(key);

            if (file) {
                // Set the correct content-type header
                res.set("Content-Type", file.mimeType);
                // Send the raw image data as the response
                res.status(200).send(file.fileData);
            } else {
                res.status(404).json({ message: "File not found." });
            }
        }catch(error){
            res.status(500).json({ message: error.message || "Internal server error" });
        }
    }

    /**
     * Uploads a file and links it to a specific ticket.
     * Expects `req.file` to be populated by Multer middleware.
     * 
     * @route POST /api/upload
     * 
     * @param {Object} req - Express request object.
     * @param {Object} req.body - Contains `fileKey` and `ticketId`.
     * @param {Object} req.file - The uploaded file object.
     * @param {Object} res - Express response object.
     */
    static async uploadFile(req, res) {
        try {
            const { fileKey, ticketId } = req.body;
            
            // Check if file exists before accessing buffer
            if (!req.file) {
                 return res.status(400).json({ message: "No file uploaded." });
            }

            if (!fileKey || !ticketId) {
                return res.status(400).json({ message: "Missing fileKey or ticketId." });
            }

            await FileService.createFile(fileKey, req.file, ticketId);
            
            res.status(201).json({ message: "File uploaded and linked to ticket successfully." });

        } catch (error) {
            // Check for a unique key violation
            if (error.number === 2627 || error.number === 2601) { 
                return res.status(409).json({ message: "This file key already exists. Please use a different key." });
            }
            res.status(500).json({ message: error.message || "Internal server error" });
        }
    }

    /**
     * Retrieves a list of files associated with a specific ticket.
     * Returns metadata only (key, name, mimeType, size) to avoid sending heavy binary payloads in a list view.
     * 
     * @route GET /api/tickets/:ticketId/files 
     * 
     * @param {Object} req - Express request object.
     * @param {string} req.params.ticketId - The ID of the ticket.
     * @param {Object} res - Express response object.
     */
    static async getFilesByTicket(req, res) {
        try {
            const { ticketId } = req.params;
            const files = await FileService.findByTicketId(ticketId);

            if (!files || files.length === 0) {
            return res.status(404).json({ message: "No files found for this ticket." });
            }

            // Return metadata only, not raw binary
            return res.status(200).json(
            files.map(f => ({
                fileKey: f.fileKey,
                name: f.fileName,
                mimeType: f.mimeType,
                size: f.fileData.length
            }))
            );
        } catch (error) {
            return res.status(500).json({ message: error.message || "Internal server error" });
        }
    }

    /**
     * Deletes a file by its unique key.
     * 
     * @route DELETE /api/files/:key
     * 
     * @param {Object} req - Express request object.
     * @param {string} req.params.key - The unique key of the file to delete.
     * @param {Object} res - Express response object.
     */
    static async deleteFile(req, res) {
        try {
            const { key } = req.params;
            
            // Call service to delete
            const result = await FileService.deleteFile(key);

            // Check if any row was affected (deleted)
            if (result.affected === 0) {
                return res.status(404).json({ message: "File not found or already deleted." });
            }

            res.status(200).json({ message: "File deleted successfully." });

        } catch (error) {
            res.status(500).json({ message: error.message || "Internal server error" });
        }
    }
}

module.exports = { FileController };</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addTicketNote">addTicketNote</a></li><li><a href="global.html#assignTicketSelf">assignTicketSelf</a></li><li><a href="global.html#assignTicketUser">assignTicketUser</a></li><li><a href="global.html#authenticateToken">authenticateToken</a></li><li><a href="global.html#authorize">authorize</a></li><li><a href="global.html#connectSSE">connectSSE</a></li><li><a href="global.html#createGenericController">createGenericController</a></li><li><a href="global.html#createTicket">createTicket</a></li><li><a href="global.html#deleteTicket">deleteTicket</a></li><li><a href="global.html#getAll">getAll</a></li><li><a href="global.html#getAllArchivedTickets">getAllArchivedTickets</a></li><li><a href="global.html#getAllTickets">getAllTickets</a></li><li><a href="global.html#getArchivedTicketByID">getArchivedTicketByID</a></li><li><a href="global.html#getArchivedTicketsByWorkOrder">getArchivedTicketsByWorkOrder</a></li><li><a href="global.html#getLaborDepartmentsByWorkOrder">getLaborDepartmentsByWorkOrder</a></li><li><a href="global.html#getNonconformancesByWorkOrder">getNonconformancesByWorkOrder</a></li><li><a href="global.html#getSequencesByWorkOrder">getSequencesByWorkOrder</a></li><li><a href="global.html#getTicketById">getTicketById</a></li><li><a href="global.html#getTicketNotes">getTicketNotes</a></li><li><a href="global.html#getTicketsByWorkOrder">getTicketsByWorkOrder</a></li><li><a href="global.html#getUnitsByWorkOrder">getUnitsByWorkOrder</a></li><li><a href="global.html#getWorkOrderSummary">getWorkOrderSummary</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#mapRoleStringToId">mapRoleStringToId</a></li><li><a href="global.html#updateTicket">updateTicket</a></li><li><a href="global.html#updateTicketStatus">updateTicketStatus</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Wed Dec 10 2025 02:11:50 GMT-0500 (Eastern Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
